<!DOCTYPE html>
<html>
  <head>


    <!-- HTML meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta name="author" content="pauldijou">
    <meta name="description" content="" />
    
      <meta name="keywords" content="npm, tooling">
    

    <title>Paul Dijou - WTF npm update?!</title>

    <!-- facebook open graph tags http://ogp.me/ -->
    <meta property="og:site_name" content="Paul Dijou" />
    <meta property="og:title" content="WTF npm update?!" />
    <meta property="og:url" content="http://pauldijou.fr/blog/2015/06/07/wtf-npm-update/" />
    <meta property="og:description" content="" />
    
      <meta property="og:type" content="article" />
      <meta property="article:published_time" content="2015-06-07T00:00:00+00:00" />
    
    
      <meta property="article:author" content="Paul Dijou" />
    
    
      <meta property="article:tag" content="npm" />
    
      <meta property="article:tag" content="tooling" />
    

    <!-- twitter card tags https://dev.twitter.com/cards/markup -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@paul_dijou" />
    
      <meta name="twitter:creator" content="@paul_dijou" />
    
    <meta name="twitter:title" content="Paul Dijou - WTF npm update?!" />
    <meta name="twitter:description" content="" />

    <link rel="shortcut icon" type="image/png" href="/assets/favicon-5b92c61126199f7d62a67cca38b3e33bbdd0f7a7a836dbda27ef0f09ffd3e5eb.ico"/>
    <link type="text/css" rel="stylesheet" href="/assets/css/main-e66cbeb83467c4596e317baff024f2f5aafbe0950e29acbcca992eddbcabe00c.css">
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet' type='text/css'/>

    <!--[if lt IE 8]>
      <link href="/stylesheets/ie.css" media="screen, projection" rel="stylesheet" type="text/css">
    <![endif]-->

    

    
      <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-25058935-1', 'auto');
        ga('send', 'pageview');
      </script>
    
  </head>
  <body>
    <header id="nav" class="nav">
  <ul class="list-unstyled">
    
      <li>
        <a href="/">
          <span class="icon fa fa-home fa-fw fa-2x"></span>
          <span class="nav-label">Home</span>
        </a>
      </li>
    
      <li>
        <a href="/blog/">
          <span class="icon fa fa-coffee fa-fw fa-2x"></span>
          <span class="nav-label">Blog</span>
        </a>
      </li>
    
      <li>
        <a href="/resume/">
          <span class="icon fa fa-code fa-fw fa-2x"></span>
          <span class="nav-label">Resume</span>
        </a>
      </li>
    
      <li>
        <a href="/projects/">
          <span class="icon fa fa-flask fa-fw fa-2x"></span>
          <span class="nav-label">Projects</span>
        </a>
      </li>
    
      <li>
        <a href="/about/">
          <span class="icon fa fa-user fa-fw fa-2x"></span>
          <span class="nav-label">About</span>
        </a>
      </li>
    
      <li>
        <a href="/contact/">
          <span class="icon fa fa-envelope fa-fw fa-2x"></span>
          <span class="nav-label">Contact</span>
        </a>
      </li>
    
      <li>
        <a href="/archives/">
          <span class="icon fa fa-archive fa-fw fa-2x"></span>
          <span class="nav-label">Archives</span>
        </a>
      </li>
    
    <li class="nav-back">
      <a href="#">
        <span class="icon fa fa-undo fa-fw fa-2x"></span>
        <span class="nav-label">Back to page</span>
      </a>
    </li>
  </ul>
</header>

<div class="nav-menu">
  <a href="#nav">Menu</a>
</div>

<div class="page container">
  











<article class="post">
  <h2>
    <a href="/blog/2015/06/07/wtf-npm-update/">WTF npm update?!</a>
  </h2>

  <div class="meta">
    Posted by
    <span class="author">Paul Dijou</span>
    
      on
      <span class="date">Jun 07, 2015</span>
    
    <span class="separator"></span>

    
      <span class="visible-md-inline visible-lg-inline"><span class="icon fa fa-comments fa-fw"></span></span>
      <a href="/blog/2015/06/07/wtf-npm-update/#disqus_thread" data-disqus-identifier="/blog/2015/06/07/wtf-npm-update">Comments</a>
      <span class="separator"></span>
    

    <span class="visible-md-inline visible-lg-inline"><span class="icon fa fa-pencil-square-o fa-fw"></span></span>
    <a class="improve visible-md-inline visible-lg-inline" href="https://github.com/pauldijou/pauldijou.github.com/edit/develop/_posts/2015-06-07-wtf-npm-update.md" target="_blank">Improve this article</a>
  </div>

  <div class="content">
    <h3 id="tldr">tl;dr</h3>

<p>Do not use <code class="highlighter-rouge">npm update</code> with any package which use custom dist-tags.</p>

<h3 id="dist-tags">Dist-tags</h3>

<p>This package has officially those 3 last versions: <code class="highlighter-rouge">1.0.0</code>, <code class="highlighter-rouge">1.0.1</code> and <code class="highlighter-rouge">1.0.2</code>. But inside the <code class="highlighter-rouge">dist-tags</code> (<a href="https://docs.npmjs.com/cli/dist-tag">read more</a>), we have two of them: the classic <code class="highlighter-rouge">latest</code> which refers to the latest stable release of the package and a custom one, named <code class="highlighter-rouge">canary</code>, indicating the last non-stable release of the package. If you are wondering if real projects are using such tags, the answer is <strong>yes</strong>, the <code class="highlighter-rouge">npm</code> package is using <code class="highlighter-rouge">latest</code> and <code class="highlighter-rouge">next</code> tags for it’s weekly pre-release (<a href="https://github.com/npm/npm/wiki/Release-Process">read more</a>).</p>

<p>Currently, <code class="highlighter-rouge">latest</code> points to <code class="highlighter-rouge">1.0.1</code> and <code class="highlighter-rouge">canary</code> to <code class="highlighter-rouge">1.0.2</code>. Meaning that if you run <code class="highlighter-rouge">npm view test-npm-update</code>, you will have something like:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test-npm-update"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="p">,</span><span class="w">
  </span><span class="s2">"dist-tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"latest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"canary"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.2"</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="s2">"versions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w"> </span><span class="s2">"1.0.1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"1.0.2"</span><span class="p">],</span><span class="w">
  </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.1"</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<h3 id="versions">Versions</h3>

<p>It’s important to realize a few things here. <code class="highlighter-rouge">1.0.2</code> is a released version just as <code class="highlighter-rouge">1.0.0</code> and <code class="highlighter-rouge">1.0.1</code> and we will say it’s the <strong>greatest</strong> one (as in the biggest number according to semver) but not the <strong>latest</strong> one (as in the one tagged with the <code class="highlighter-rouge">latest</code> dist-tag). We need to make such distinction to fully understand what will happen after that.</p>

<p>So, when you run <code class="highlighter-rouge">npm view test-npm-update</code>, it actually runs <code class="highlighter-rouge">npm view test-npm-update@latest</code>, meaning it will grab the informations of the <strong>latest</strong> version. But maybe some other versions have been released with a custom tag after this one. For me, so far, so good. NPM is doing exactly what I would expect. If I want a custom release such as the canary one, I can run <code class="highlighter-rouge">npm view test-npm-update@canary</code> and it will display infos about the <code class="highlighter-rouge">1.0.2</code> version. In fact, but I might be wrong but I except NPM to always use the <strong>latest</strong> version (aka the <code class="highlighter-rouge">latest</code> dist-tag) by default if I don’t specify anything. That’s what you can mostly read all over the NPM documentation.</p>

<p>But remember, <code class="highlighter-rouge">1.0.2</code> is inside the <code class="highlighter-rouge">versions</code> array just like any other version. So first warning, if you use such metadata for whatever stuff you are doing, do not assume that the <strong>greatest</strong> version inside the <code class="highlighter-rouge">versions</code> array is the <strong>latest</strong> one.</p>

<h3 id="install">Install</h3>

<p>Now, what if I run <code class="highlighter-rouge">npm install test-npm-update</code>? What would you expect to be installed? <code class="highlighter-rouge">1.0.1</code> right? And of course it will be this version, the <strong>latest</strong> one. That’s normal, after all, <strong>latest</strong> is the default one. All good here.</p>

<p>What if I clean my folder and then run <code class="highlighter-rouge">npm install test-npm-update@^1.0.0</code>? Guess what, <code class="highlighter-rouge">1.0.1</code> will be installed. And I’m totally ok with that. I asked for the best 1.x.x version and I’m glad to have the <strong>latest</strong> one since it matches.</p>

<h3 id="packagejson">package.json</h3>

<p>But most of the time, you don’t install or update from command line, you have a <code class="highlighter-rouge">package.json</code> file with a range inside it. Let’s say we have the following one:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"awesome-project"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"test-npm-update"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^1.0.0"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<p>Pretty classic, right? Now, for the purpose of the demo, let’s say we currently have the <code class="highlighter-rouge">1.0.0</code> version of <code class="highlighter-rouge">test-npm-update</code> locally installed. If you want to reproduce, just create an empty folder, then create a <code class="highlighter-rouge">package.json</code> inside it with the previous content and run <code class="highlighter-rouge">npm install test-npm-update@1.0.0</code> to force the install of an old version.</p>

<p>Done? Cool, let’s move forward. NPM has a command to test if you have outdated versions locally installed. Which is our case. Let’s check that by running <code class="highlighter-rouge">npm outdated</code>. You should have something like:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Package          Current  Wanted  Latest  Location
<span class="nb">test</span>-npm-update  1.0.0    1.0.2   1.0.1</code></pre></figure>

<p>Wait a minute? I’m ok with <em>current</em> (the locally installed) being <code class="highlighter-rouge">1.0.0</code> and <em>latest</em> (matching the dist-tag) being <code class="highlighter-rouge">1.0.1</code> but <em>wanted</em> is supposed to be the best matching version I should install according to <code class="highlighter-rouge">package.json</code>. How can it be greater than <em>latest</em>?</p>

<p>Actually, it’s all ok according to the NPM documentation. After all, the <code class="highlighter-rouge">package.json</code> range is <code class="highlighter-rouge">^1.0.0</code> which means the greatest possible version without changing the first non-zero digit. And among <strong>all</strong> our versions (see the <code class="highlighter-rouge">versions</code> array from <code class="highlighter-rouge">npm view</code>), both <code class="highlighter-rouge">1.0.1</code> and <code class="highlighter-rouge">1.0.2</code> match this range, but since <code class="highlighter-rouge">1.0.2</code> is greater than <code class="highlighter-rouge">1.0.1</code>, the <em>wanted</em> version is <code class="highlighter-rouge">1.0.2</code>.</p>

<p>I didn’t expect that to be honest. That’s not wrong but I can’t help myself finding that strange.</p>

<h3 id="install-again">Install again</h3>

<p>Quick mention to the fact that if I run <code class="highlighter-rouge">npm install</code> with my <code class="highlighter-rouge">package.json</code> in an empty folder (aka without the <code class="highlighter-rouge">1.0.0</code> version already installed), it will still install <code class="highlighter-rouge">1.0.1</code> version. That’s ok according to <strong>latest</strong> being the default one. Back to our outdated <code class="highlighter-rouge">1.0.0</code> version.</p>

<h3 id="update">Update</h3>

<p>Things start to get really ugly now. So, <code class="highlighter-rouge">npm outdated</code> just told me I have an old local version. I should probably update it, and NPM has a command for that. Let’s run <code class="highlighter-rouge">npm update</code>. To be honest, I wasn’t sure anymore what would be installed locally. I mean, I would have normally expected the <code class="highlighter-rouge">1.0.1</code> version. My brain was like “It should be the greatest <strong>stable</strong> version which match the range”, with <strong>stable</strong> meaning lower or equal to the <code class="highlighter-rouge">latest</code> tag, but for NPM, it’s more like “It should be the greatest version which match the range. Period.”. And it makes all the difference. My brain stops at <code class="highlighter-rouge">1.0.1</code> as the latest stable but NPM browse <strong>all</strong> version, including any custom dist-tags, including the <code class="highlighter-rouge">canary</code> version.</p>

<p>At the end, running <code class="highlighter-rouge">npm update</code> will install <code class="highlighter-rouge">1.0.2</code> version. This is <strong>wrong</strong>. According to <a href="https://docs.npmjs.com/cli/update">documentation</a>:</p>

<blockquote>
  <p>This command will update all the packages listed to the latest version (specified by the tag config), respecting semver.</p>
</blockquote>

<p>I read that as the <strong>latest</strong> version according to <code class="highlighter-rouge">latest</code> dist-tag. But we just updated to a version beyond this <strong>latest</strong> version. In any case, this is super dangerous! It means you can update to non-stable versions without even noticing it.</p>

<p>What if we didn’t have the <code class="highlighter-rouge">1.0.0</code> already installed? Since <code class="highlighter-rouge">npm update</code> also install missing packages, it will indeed install <code class="highlighter-rouge">test-npm-update</code> according to <code class="highlighter-rouge">package.json</code> and, of course, to the <code class="highlighter-rouge">1.0.2</code> version.</p>

<h3 id="conclusion">Conclusion</h3>

<p>IMHO, I think this is way too dangerous, <code class="highlighter-rouge">npm update</code> should be capped by the <strong>latest</strong> version, and so should <code class="highlighter-rouge">npm outdated</code>. By default, no command should target versions beyond <code class="highlighter-rouge">latest</code> dist-tag. Also, it seems inconsistent to have <code class="highlighter-rouge">install</code> and <code class="highlighter-rouge">update</code> both capable of installing a missing package from a <code class="highlighter-rouge">package.json</code> file but not to the same version.</p>

<p>I raised an issue on <a href="https://github.com/npm/npm/issues/8476">Github</a>, we will see. Be careful from now on.</p>

<p>Thanks for reading! Spread the word.</p>

<h3 id="personal-ad">Personal ad</h3>

<p>It might be a bit too early to speak about that, but if you need an <code class="highlighter-rouge">outdated</code> command which is actually capped by the <code class="highlighter-rouge">latest</code> tag and also support other package managers (like Bower), please check my <a href="https://github.com/pauldijou/outdated">outdated</a> project. It’s not ready at all yet but it will be in the next few days, promise.</p>

  </div>

  <div class="footer">
    <span class="hidden-xs hidden-sm">
      <span class="icon fa fa-link fa-fw"></span>
      <a href="http://pauldijou.fr/blog/2015/06/07/wtf-npm-update/">Permalink</a>
    </span>
    <span class="separator"></span>

    <span class="visible-md-inline visible-lg-inline"><span class="icon fa fa-pencil-square-o fa-fw"></span></span>
    <a href="https://github.com/pauldijou/pauldijou.github.com/edit/develop/_posts/2015-06-07-wtf-npm-update.md" target="_blank" class="improve visible-md-inline visible-lg-inline">Improve this article</a>
    <a href="https://github.com/pauldijou/pauldijou.github.com/edit/develop/_posts/2015-06-07-wtf-npm-update.md" target="_blank" class="improve button block hidden-md hidden-lg">
      <span class="icon fa fa-pencil-square fa-fw"></span>
      Improve this article
    </a>

    
      <div class="tags">
        <span class="icon fa fa-tags fa-fw"></span>
        Tags:
        
          <a class="tag label label-default" href="/blog/tags/npm/">npm</a>
        
          <a class="tag label label-default" href="/blog/tags/tooling/">tooling</a>
        
      </div>
    

  </div>

  
    
  <div class="pagination">
    <div class="row">
      <div class="col-xs-6">
        
          <a class="button block previous" href="/blog/2014/08/05/browser-sync-play-framework/">Previous</a>
        

      </div>
      <div class="col-xs-6">
        
          <a class="button block next" href="/blog/2017/01/23/elm-native-basics/">Next</a>
        
      </div>
    </div>
  </div>

  <div id="disqus_thread"></div>

  <script>
    // Learn more: https://disqus.com/admin/universalcode/#configuration-variables
    var disqus_config = function () {
      this.page.url = 'http://pauldijou.fr/blog/2015/06/07/wtf-npm-update/';  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = '/blog/2015/06/07/wtf-npm-update'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      this.page.title = 'WTF npm update?!';
      // this.page.category_id = '';
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://pauldijou.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

  
</article>


<script id="dsq-count-scr" src="//pauldijou.disqus.com/count.js" async></script>

</div>


    <script type="text/javascript" src="/assets/js/main-a35bb44a42985a5ff06fe724109076616abccf20668ed9c7419518a3b125015d.js"></script>

    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->

    
  </body>
</html>
