<!DOCTYPE html>
<html>
  <head>


    <!-- HTML meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta name="author" content="pauldijou">
    <meta name="description" content="" />
    
      <meta name="keywords" content="prismic">
    

    <title>Paul Dijou - Prismic.io JavaScript kit: from callbacks to promises</title>

    <!-- facebook open graph tags http://ogp.me/ -->
    <meta property="og:site_name" content="Paul Dijou" />
    <meta property="og:title" content="Prismic.io JavaScript kit: from callbacks to promises" />
    <meta property="og:url" content="http://pauldijou.fr/blog/2014/07/26/prismicio-javascript-kit-from-callbacks-to-promises/" />
    <meta property="og:description" content="" />
    
      <meta property="og:type" content="article" />
      <meta property="article:published_time" content="2014-07-26T00:00:00+00:00" />
    
    
      <meta property="article:author" content="Paul Dijou" />
    
    
      <meta property="article:tag" content="prismic" />
    

    <!-- twitter card tags https://dev.twitter.com/cards/markup -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@paul_dijou" />
    
      <meta name="twitter:creator" content="@paul_dijou" />
    
    <meta name="twitter:title" content="Paul Dijou - Prismic.io JavaScript kit: from callbacks to promises" />
    <meta name="twitter:description" content="" />

    <link rel="shortcut icon" type="image/png" href="/assets/favicon-5b92c61126199f7d62a67cca38b3e33bbdd0f7a7a836dbda27ef0f09ffd3e5eb.ico"/>
    <link type="text/css" rel="stylesheet" href="/assets/css/main-e66cbeb83467c4596e317baff024f2f5aafbe0950e29acbcca992eddbcabe00c.css">
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400' rel='stylesheet' type='text/css'/>

    <!--[if lt IE 8]>
      <link href="/stylesheets/ie.css" media="screen, projection" rel="stylesheet" type="text/css">
    <![endif]-->

    

    
      <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-25058935-1', 'auto');
        ga('send', 'pageview');
      </script>
    
  </head>
  <body>
    <header id="nav" class="nav">
  <ul class="list-unstyled">
    
      <li>
        <a href="/">
          <span class="icon fa fa-home fa-fw fa-2x"></span>
          <span class="nav-label">Home</span>
        </a>
      </li>
    
      <li>
        <a href="/blog/">
          <span class="icon fa fa-coffee fa-fw fa-2x"></span>
          <span class="nav-label">Blog</span>
        </a>
      </li>
    
      <li>
        <a href="/resume/">
          <span class="icon fa fa-code fa-fw fa-2x"></span>
          <span class="nav-label">Resume</span>
        </a>
      </li>
    
      <li>
        <a href="/projects/">
          <span class="icon fa fa-flask fa-fw fa-2x"></span>
          <span class="nav-label">Projects</span>
        </a>
      </li>
    
      <li>
        <a href="/about/">
          <span class="icon fa fa-user fa-fw fa-2x"></span>
          <span class="nav-label">About</span>
        </a>
      </li>
    
      <li>
        <a href="/contact/">
          <span class="icon fa fa-envelope fa-fw fa-2x"></span>
          <span class="nav-label">Contact</span>
        </a>
      </li>
    
      <li>
        <a href="/archives/">
          <span class="icon fa fa-archive fa-fw fa-2x"></span>
          <span class="nav-label">Archives</span>
        </a>
      </li>
    
    <li class="nav-back">
      <a href="#">
        <span class="icon fa fa-undo fa-fw fa-2x"></span>
        <span class="nav-label">Back to page</span>
      </a>
    </li>
  </ul>
</header>

<div class="nav-menu">
  <a href="#nav">Menu</a>
</div>

<div class="page container">
  











<article class="post">
  <h2>
    <a href="/blog/2014/07/26/prismicio-javascript-kit-from-callbacks-to-promises/">Prismic.io JavaScript kit: from callbacks to promises</a>
  </h2>

  <div class="meta">
    Posted by
    <span class="author">Paul Dijou</span>
    
      on
      <span class="date">Jul 26, 2014</span>
    
    <span class="separator"></span>

    
      <span class="visible-md-inline visible-lg-inline"><span class="icon fa fa-comments fa-fw"></span></span>
      <a href="/blog/2014/07/26/prismicio-javascript-kit-from-callbacks-to-promises/#disqus_thread" data-disqus-identifier="/blog/2014/07/26/prismicio-javascript-kit-from-callbacks-to-promises">Comments</a>
      <span class="separator"></span>
    

    <span class="visible-md-inline visible-lg-inline"><span class="icon fa fa-pencil-square-o fa-fw"></span></span>
    <a class="improve visible-md-inline visible-lg-inline" href="https://github.com/pauldijou/pauldijou.github.com/edit/develop/_posts/2014-07-26-prismicio-javascript-kit-from-callbacks-to-promises.md" target="_blank">Improve this article</a>
  </div>

  <div class="content">
    <h3 id="holy-cow-callbacks">Holy cow, callbacks!</h3>

<p>For the last (and only) website I did using prismic.io, I didn’t want any back-end, all client-side, pure JavaScript man. This way, I could host it nearly anywhere for pretty much free (GitHub pages FTW). To ease stuff, I decided to use the <a href="https://github.com/prismicio/javascript-kit">JavaScript kit</a> from the prismic.io team.</p>

<p>One choice they made and that I don’t really like is using callbacks in it. For example, you have to write stuff like:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Get the current API</span>
<span class="nx">Prismic</span><span class="p">.</span><span class="nx">Api</span><span class="p">(</span><span class="s1">'/my/awesome/url'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">api</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// handle error</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Use the API there, retrieving documents</span>
  <span class="nx">api</span><span class="p">.</span><span class="nx">form</span><span class="p">(</span><span class="s1">'articles'</span><span class="p">).</span><span class="nx">ref</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">master</span><span class="p">()).</span><span class="nx">submit</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">articles</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Also error again</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// But I also need authors...</span>
    <span class="nx">api</span><span class="p">.</span><span class="nx">form</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">).</span><span class="nx">ref</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">master</span><span class="p">()).</span><span class="nx">submit</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">authors</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// One more time, handle error</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// Now I got all my data</span>
      <span class="c1">// I can finally display it on my page</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">},</span> <span class="s1">'my_token_far_below_at_the_end'</span><span class="p">);</span></code></pre></figure>

<p>Can you see it? This ugly thing JavaScript experts name “callback hell”? And that’s a super simple example. In 2014, the way to do that is using Promises. That’s what’s hype (and readable, and nice, and cool, and swag). But I quite understand why they made this choice. Promises are not native everywhere yet, so going with it mean either writing your own implementation or imposing an existing one. Fair enough to have callbacks in the kit then, but we are hackers here, we can override it to use Promises!</p>

<p class="alert alert-danger">I will use the last spec Promise syntax, native way baby!, but it is really important to keep in mind that it has <a href="http://caniuse.com/#search=promises">a really poor support</a> right now. You should probably be using a Javascript library as Promise implementation. I will link a snippet of code using the <a href="http://documentup.com/kriskowal/q/">Q library</a> at the end of the article. But I wanted this article to be future proof.</p>

<h3 id="omg-promises-o">OMG, promises \o/</h3>

<p>There are two main callbacks in the kit: when retrieving the API and when making a <code class="highlighter-rouge">submit</code>. What I want to write is something like:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">Api</span><span class="p">(</span><span class="s1">'/my/awesome/url'</span><span class="p">,</span> <span class="s1">'my_token_right_here_at_the_start'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">api</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">form</span><span class="p">(</span><span class="s1">'articles'</span><span class="p">).</span><span class="nx">ref</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">master</span><span class="p">()).</span><span class="nx">submit</span><span class="p">(),</span>
      <span class="nx">api</span><span class="p">.</span><span class="nx">form</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">).</span><span class="nx">ref</span><span class="p">(</span><span class="nx">api</span><span class="p">.</span><span class="nx">master</span><span class="p">()).</span><span class="nx">submit</span><span class="p">()</span>
    <span class="p">]);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">articles</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">authors</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="c1">// Display the results</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Handle error</span>
  <span class="p">});</span></code></pre></figure>

<p>Sooooo much more readable and swag… Overriding the Api callback is really simple:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Remove the callback from the function signature</span>
<span class="kd">function</span> <span class="nx">Api</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">accessToken</span><span class="p">,</span> <span class="nx">maybeRequestHandler</span><span class="p">,</span> <span class="nx">maybeApiCache</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Put a callback that will only resolve/reject the deferred depending</span>
    <span class="c1">// on the presence of an error or not</span>
    <span class="nx">Prismic</span><span class="p">.</span><span class="nx">Api</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">resolvedApi</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Save point 1 (see below)</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">resolvedApi</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="nx">accessToken</span><span class="p">,</span> <span class="nx">maybeRequestHandler</span><span class="p">,</span> <span class="nx">maybeApiCache</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

<p>Overriding the <code class="highlighter-rouge">submit</code> call is a bit more tricky because it is a prototype function of the <code class="highlighter-rouge">SearchForm</code> object, which is totally hidden inside Prismic clojure. This is a bit (super) sad but we can deal with it by creating a fake form and not submitting it. The easiest way I found so far is doing it right after getting the Api. Let’s add the following code at <code class="highlighter-rouge">Save point 1</code> (see previous code).</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// You might need a polyfill for 'getPrototypeOf'</span>
<span class="c1">// if you support old browser</span>
<span class="kd">var</span> <span class="nx">SearchFormProto</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getPrototypeOf</span><span class="p">(</span><span class="nx">resolvedApi</span><span class="p">.</span><span class="nx">forms</span><span class="p">(</span><span class="s1">'everything'</span><span class="p">));</span>
<span class="c1">// We are saving the original function so we can call it inside our override</span>
<span class="kd">var</span> <span class="nx">originalSubmit</span> <span class="o">=</span> <span class="nx">SearchFormProto</span><span class="p">.</span><span class="nx">submit</span><span class="p">;</span>

<span class="c1">// Let's override!</span>
<span class="nx">SearchFormProto</span><span class="p">.</span><span class="nx">submit</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// As before, the callback will only resolve / reject the deferred</span>
    <span class="c1">// depending on the returned value</span>
    <span class="nx">originalSubmit</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="p">(</span><span class="nx">docs</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></code></pre></figure>

<p>And after that, you just need to use the new <code class="highlighter-rouge">Api</code> function in place of <code class="highlighter-rouge">Prismic.Api</code>. You can see <a href="https://github.com/pauldijou/farewell/blob/9a744565d7/scripts%2Fapi.js#L8-L32">the full code here</a> using <code class="highlighter-rouge">Q</code> library. This refers to a particular commit to ensure the line highlight is correct but you can freely switch to the master branch to see the most recent code (which shouldn’t be much different… but who knows…).</p>

<p>Thanks for reading. Next time we will talk about responsive images inside StructuredText.</p>

  </div>

  <div class="footer">
    <span class="hidden-xs hidden-sm">
      <span class="icon fa fa-link fa-fw"></span>
      <a href="http://pauldijou.fr/blog/2014/07/26/prismicio-javascript-kit-from-callbacks-to-promises/">Permalink</a>
    </span>
    <span class="separator"></span>

    <span class="visible-md-inline visible-lg-inline"><span class="icon fa fa-pencil-square-o fa-fw"></span></span>
    <a href="https://github.com/pauldijou/pauldijou.github.com/edit/develop/_posts/2014-07-26-prismicio-javascript-kit-from-callbacks-to-promises.md" target="_blank" class="improve visible-md-inline visible-lg-inline">Improve this article</a>
    <a href="https://github.com/pauldijou/pauldijou.github.com/edit/develop/_posts/2014-07-26-prismicio-javascript-kit-from-callbacks-to-promises.md" target="_blank" class="improve button block hidden-md hidden-lg">
      <span class="icon fa fa-pencil-square fa-fw"></span>
      Improve this article
    </a>

    
      <div class="tags">
        <span class="icon fa fa-tags fa-fw"></span>
        Tags:
        
          <a class="tag label label-default" href="/blog/tags/prismic/">prismic</a>
        
      </div>
    

  </div>

  
    
  <div class="pagination">
    <div class="row">
      <div class="col-xs-6">
        
          <a class="button block previous" href="/blog/2014/07/17/prismicio-when-happiness-met-disappointment/">Previous</a>
        

      </div>
      <div class="col-xs-6">
        
          <a class="button block next" href="/blog/2014/08/01/doing-conference-website-two-days/">Next</a>
        
      </div>
    </div>
  </div>

  <div id="disqus_thread"></div>

  <script>
    // Learn more: https://disqus.com/admin/universalcode/#configuration-variables
    var disqus_config = function () {
      this.page.url = 'http://pauldijou.fr/blog/2014/07/26/prismicio-javascript-kit-from-callbacks-to-promises/';  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = '/blog/2014/07/26/prismicio-javascript-kit-from-callbacks-to-promises'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      this.page.title = 'Prismic.io JavaScript kit: from callbacks to promises';
      // this.page.category_id = '';
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://pauldijou.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>

  
</article>


<script id="dsq-count-scr" src="//pauldijou.disqus.com/count.js" async></script>

</div>


    <script type="text/javascript" src="/assets/js/main-a35bb44a42985a5ff06fe724109076616abccf20668ed9c7419518a3b125015d.js"></script>

    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->

    
  </body>
</html>
